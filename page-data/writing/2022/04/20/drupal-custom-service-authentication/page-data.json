{
    "componentChunkName": "component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx",
    "path": "/writing/2022/04/20/drupal-custom-service-authentication",
    "result": {"data":{"post":{"slug":"/2022/04/20/drupal-custom-service-authentication","title":"Drupal Custom Service w/ Authentication","date":"Apr 20, 2022","tags":[{"name":"Technology","slug":"technology"},{"name":"Drupal","slug":"drupal"},{"name":"PHP","slug":"php"},{"name":"GuzzleHttp","slug":"guzzle-http"}],"description":"Connecting Drupal to a Google Authenticated Back End","canonicalUrl":null,"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Drupal Custom Service w/ Authentication\",\n  \"description\": \"Connecting Drupal to a Google Authenticated Back End\",\n  \"date\": \"2022-04-20T00:00:00.000Z\",\n  \"tags\": [\"Technology\", \"Drupal\", \"PHP\", \"GuzzleHttp\"],\n  \"slug\": \"/2022/04/20/drupal-custom-service-authentication\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Since I've had the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"opportunity\"), \" (for lack of a better word) to continue down the Drupal rabbit hole - the next requirements of our project required that we have Drupal communciating with our back end services (Java).  Our application is based around Google OAuth and therefore it made sense to implement:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A custom Http client on Drupal\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Using Google Service Accounts as authentication\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Performing the appropriate validation on the back end\")), mdx(\"h2\", null, \"Custom Drupal Client\"), mdx(\"p\", null, \"As much as \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"I absolutely love\"), \" Drupal, the Drupal 8 Service configuration and Injection Container was actually a delight to work with.   I found a number of great articles on creating an Http Client using the built in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GuzzleHttp\\\\Client\"), \" library.\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://drupalize.me/blog/201512/speak-http-drupal-httpclient\"\n  }, \"https://drupalize.me/blog/201512/speak-http-drupal-httpclient\"), \" being the primary one\")), mdx(\"p\", null, \"There are a number of different approaches that can be taken here:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Implementing a Factory to provide a standard \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"GuzzleHttp\\\\Client\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Implementing a custom client\")), mdx(\"p\", null, \"To give an idea of the differences, it's all dependent on how much (or little) custom functionality we need to provide.  The way I look at it is that I'll provide a number of levels:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Factory\"), \" which will create the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"GuzzleHttp\\\\Client\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"GuzzleHttp\\\\Client\"), \" \", mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"service\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A standard data wrapping service \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"DataService\"), \" wrapping Drupal logging functionality\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Any number of added services \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"MemberService\"), \", etc. that will be used to provide \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"#getContactInfo()\"), \" specific functions\")), mdx(\"h3\", null, \"Module Service YML File\"), mdx(\"p\", null, \"At this point, we'll just get the Service and Factory configured and available:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yml:title=module.services.yml\"\n  }, \"  module.service_client:\\n    class: GuzzleHttp\\\\Client \\n    factory: module.service_client_factory:get \\n  module.service_client_factory:\\n    class: Drupal\\\\module\\\\Services\\\\ServiceClientFactory\\n\")), mdx(\"h3\", null, \"Implementing the Factory\"), mdx(\"p\", null, \"Next we'll need to implement the factory, the primary methods are:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"#get()\"), \" which returns the simple \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"new Client()\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"#handler_stack()\"), \" which we use to build the appropriate middleware\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php:title=ServiceClientFactory\"\n  }, \"class ServiceClientFactory {\\n    function get() {\\n        $config = [\\n            'base_uri' => Settings::get('client_uri'),\\n            'handler' => $this->handler_stack()\\n        ];\\n        \\n        return new Client($config);\\n    }\\n    \\n    function handler_stack() {\\n        $stack = HandlerStack::create();\\n        $stack->push(new Authentication(Settings::get('client_email'), Settings::get('client_pkey'), Settings::get('client_key')));\\n        return $stack;\\n    }    \\n}\\n\")), mdx(\"p\", null, \"At this point we are able to inject the basic client into any \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Service\"), \"(s) or \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Controllers\"), \"(s) using the standard injection code:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php:title=Member\",\n    \"metastring\": \"Profile Controller\",\n    \"Profile\": true,\n    \"Controller\": true\n  }, \"class MemberProfileController extends ControllerBase {\\n\\n    /**\\n     * @var \\\\GuzzleHttp\\\\Client\\n     */\\n    protected $client;\\n\\n    public function __construct(Client $client) {\\n        $this->Client = $client;\\n    }\\n\\n    public static function create(ContainerInterface $container) {\\n        return new static(\\n            $container->get('module.service_client')\\n        );\\n    }\\n\\n    public function memberProfileTitle() {\\n        return \\\"Member Profile {$this->currentUser()->getAccountName()}\\\";\\n    }\\n\\n    public function memberProfile($userId) {\\n        $memberProfile = $this->client->get(\\\"members/#{$this->currentUser()->memberNumber()}/profile\\\");\\n        return [\\n            '#markup' => \\\"This is the member profile {dump($memberProfile)}\\\"\\n        ];\\n    }\\n}\\n\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"At this point with the appropriate configuration for the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"MemberProfileController\"), \" routing we should start seeing some errors!!  We still need authentication setup.\")), mdx(\"h2\", null, \"Google Authentication\"), mdx(\"p\", null, \"We're using Google Service Accounts for this, but essentially any authentication mechanism will work.  To get up and running with Google Service Accounts we can jump over to \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://cloud.google.com/iam/docs/understanding-service-accounts\"\n  }, \"https://cloud.google.com/iam/docs/understanding-service-accounts\"), \" and get started.  \"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Magic happens and we download our \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"service-account.json\"), \" file\")), mdx(\"p\", null, \"The json file you get back will look like this:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-json:title=Service\",\n    \"metastring\": \"Account Json\",\n    \"Account\": true,\n    \"Json\": true\n  }, \"{\\n  \\\"type\\\": \\\"service_account\\\",\\n  \\\"project_id\\\": \\\"project_id\\\",\\n  \\\"private_key_id\\\": \\\"private_key_id\\\",\\n  \\\"private_key\\\": \\\"-----BEGIN PRIVATE KEY-----\\\\n-----END PRIVATE KEY-----\\\\n\\\",\\n  \\\"client_email\\\": \\\"client@service.google.com\\\",\\n  \\\"client_id\\\": \\\"client_id\\\",\\n  \\\"auth_uri\\\": \\\"https://accounts.google.com/o/oauth2/auth\\\",\\n  \\\"token_uri\\\": \\\"https://oauth2.googleapis.com/token\\\",\\n  \\\"auth_provider_x509_cert_url\\\": \\\"https://www.googleapis.com/oauth2/v1/certs\\\",\\n  \\\"client_x509_cert_url\\\": \\\"https://custom_public_key_url\\\"\\n}\\n\")), mdx(\"p\", null, \"In order to process the JWT I started using the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/firebase/php-jwt\"\n  }, \"firebase/php-jwt\"), \" library.\"), mdx(\"h3\", null, \"Drupal Settings\"), mdx(\"p\", null, \"To make the configuration available, we need to pop some of these items into the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"settings.local.php\"), \" file (or .env file if preferred).\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php:title=settings.local.php\"\n  }, \"$settings['client_uri'] = 'http://localhost:8080/api/';\\n$settings['client_email'] = 'client@service.google.com';\\n$settings['client_pkey'] = '-----BEGIN PRIVATE KEY-----=\\n-----END PRIVATE KEY-----';\\n$settings['client_key'] = 'private_key_id';\\n\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"One important thing to note, firebase/php-jwt does not like the private key with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"\\\\n\"), \" in it.  You'll need to replace the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"\\\\n\"), \" with actual new lines in the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"settings.local.php\"), \" file.\")), mdx(\"p\", null, \"Now that we have the configuration available, we can implement the\"), mdx(\"h3\", null, \"Authentication Middleware\"), mdx(\"p\", null, \"The authentication middleware is solely responsible for applying the appropriate \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Authentication: Bearer <JWT>\"), \" header to each of our requests.  We can see that there are two functions \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"#header()\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"#body()\"), \" responsible for generating the appropriate arrays, which is then generated using \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"JWT::encode()\"), \" and assigned to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Authentication\"), \" header:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-php:title=Authentication\",\n    \"metastring\": \"Middleware\",\n    \"Middleware\": true\n  }, \"class Authentication {\\n    // Constructor and field definition\\n    \\n    public function __invoke(callable $handler) {\\n        return function(RequestInterface $request, array $options = []) use ($handler) {        \\n            $body = $this->body();\\n            $jwt = JWT::encode($body, $this->privateKey, \\\"RS256\\\", $this->keyId, $this->headers());\\n            $request = $request->withHeader(\\\"Authentication\\\", \\\"Bearer: {$jwt});\\n\\n            return $handler($request, $options);\\n        };\\n    }\\n    \\n    private function headers() {\\n        return [\\n            \\\"alg\\\" => \\\"RS256\\\",\\n            \\\"typ\\\" => \\\"JWT\\\",\\n            \\\"kid\\\" => $this->keyId\\n        ];\\n    }\\n    \\n    private function body() {        \\n        $issuedAt = new DateTimeImmutable();\\n        return [\\n            \\\"iss\\\" => $this->email,\\n            \\\"sub\\\" => $this->email,\\n            \\\"aud\\\" => \\\"custom audience here\\\",\\n            \\\"iat\\\" => $issuedAt->getTimestamp(),\\n            \\\"exp\\\" => $issuedAt->modify('+1 hour')->getTimestamp()\\n        ];\\n    }\\n}\\n\")), mdx(\"p\", null, \"At this point you should be able to open up your configured url \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/members/12352/profile\"), \" and see the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"MemberProfileController\"), \" firing requests off to the service.  There are still a number of features left to implement:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The backend must implement the appropriate \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"GoogleAuthenticationTokenVerifier\"), \" using the supplied information from the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"json\"), \" file\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Logging and error handling should be implemented in the Client, specific to Drupal services\")), mdx(\"p\", null, \"But at this point we should be in the position to start making authenticated requests.\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"Since I've had the  opportunity  (for lack of a better word) to continue down the Drupal rabbit hole - the next requirements of our project…","timeToRead":2,"banner":null}},"pageContext":{"slug":"/2022/04/20/drupal-custom-service-authentication","formatString":"MMM DD, yyyy"}},
    "staticQueryHashes": ["2744905544","3090400250","318001574"]}